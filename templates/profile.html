{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    {% if user is none %}
        <div class="alert alert-danger" role="alert">
            <h4 class="alert-heading">Unauthorized Access!</h4>
            <p>You are not authorized to access this page. Please <a href="/login" class="alert-link">login</a> to access this page.</p>
        </div>
    {% else %}
        <div class="card mb-2 mt-2" id="card-welcome">
            <h5 class="card-header h5">Welcome, {{ user.full_name }}!</h5>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item"><strong>Full Name:</strong> {{ user.full_name }}</li>
                    <li class="list-group-item"><strong>Username:</strong> {{ user.username }}</li>
                    <li class="list-group-item"><strong>Email:</strong> {{ user.email }}</li>
                    <li class="list-group-item"><strong>Organisation:</strong> {{ user.organisation }}</li>
                    <li class="list-group-item"><strong>Role:</strong> {{ user.role }}</li>
                </ul>
            </div>
        </div>

        <!-- Include Indexer -->
        {% include 'indexer.html' %}

        <!-- Marketplace Integration Section -->
        <div class="card mb-2 mt-2" id="card-integrations">
            <h5 class="h5 card-header">Integrations</h5>
            <div class="card-body">
            {% if features.google_drive %}
                <!-- Google Drive Integration -->
                <div id="card-integration-google-drive" class="card mb-2 mt-2">
                    <h5 class="card-header h5">Google Drive</h5>
                    <div class="card-body flex">
                        <div class="col-2 mr-4 ml-2">
                            <img src="{{ url_for('static', filename='img/google_drive.png') }}" alt="Google Drive Integration" class="img-fluid">
                            <p class="card-text">Integrate your Google Drive with Lorelai to index your documents. Currently supports individual google docs and folders (we'll only pick up google docs inside those folders, other file types will be ignored)</p>
                        </div>
                        <div class="col-8">

                            <h5 class="card-title h5">Actions:</h5>
                            <p>Use the following buttons to authorize Lorelai to index specific Google Drive files and folders:</p>
                            <button class="btn btn-primary" id="authorize_button" onclick="codeClient.requestCode()">Authorize</button>
                            <button class="btn btn-secondary" id="signout_button" onclick="handleSignoutClick()">Sign Out</button>
                            <button class="btn btn-secondary" id="select_button" onclick="createPicker()">Select Folders/Documents</button>

                            <h5 class="card-title h5 mt-4">Documents Indexed:</h5>
                            <div class="list-group mt-3" id="content">
                            {%if google_docs_to_index %}
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th scope="col">Name</th>
                                            <th scope="col">Type</th>
                                            <th scope="col">Last Indexed</th>
                                            <th scope="col">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    {% for doc in google_docs_to_index %}
                                        <tr>
                                            <td><h5 class="mb-1">{{ doc.item_name }}
                                                <span class="info-icon" data-bs-toggle="tooltip" title="Google Docs ID: {{ doc.google_drive_id }}">
                                                    <i class="bi bi-info-circle"></i>
                                                </span>
                                            </h5></td>
                                            <td>{{ doc.item_type }}</td>
                                            <td>{{ doc.last_indexed_at }}</td>
                                            <td>
                                                <button class="btn btn-primary btn-sm" onclick="removeDocument('{{ doc.google_drive_id }}')">Remove from Index</button>
                                                {% if doc.item_type == 'document' %}
                                                    <button class="btn btn-primary btn-sm" onclick="window.open('https://docs.google.com/document/d/{{ doc.google_drive_id }}', '_blank')">View File</button>
                                                {% else %}
                                                    <button class="btn btn-primary btn-sm" onclick="window.open('https://drive.google.com/drive/folders/{{ doc.google_drive_id }}', '_blank')">Open Folder</button>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Slack Integration -->
            {% if features.slack == 1 %}
            <div class="card mb-3">
                <div class="card-body bg-light">
                    <div class="row">
                        <div class="col-md-4">
                            <img src="{{ url_for('static', filename='img/slack.png') }}" alt="Slack Integration" class="img-fluid">
                        </div>
                        <div class="col-md-8">
                            <h5 class="card-title font-weight-bold">Slack Integration</h5>
                            <p class="card-text">Enhance your experience by integrating Slack with our platform.</p>
                            <a href="/slack/auth" class="btn btn-primary">Start Integration</a>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    {% endif %}
</div>

<script>
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';
    const CLIENT_ID = '188814832124-jic1ovt2a8vued9je3pdcg71imrdp67c.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyBS3VWEmt4x4eDZLTcoM1qnz_ynT_UeDbM';
    const APP_ID = '188814832124';

    let codeClient;
    let accessToken = {% if google_drive_access_token %}'{{ google_drive_access_token }}'{% else %}null{% endif %};
    let authorizationCode = null;
    let pickerInited = false;
    let gisInited = false;

    document.getElementById('authorize_button').disabled = true;
    document.getElementById('signout_button').disabled = true;
    document.getElementById('select_button').disabled = true;

    function gapiLoaded() {
        gapi.load('client:picker', initializePicker);
    }

    async function initializePicker() {
        await gapi.client.load('https://www.googleapis.com/discovery/v1/apis/drive/v3/rest');
        pickerInited = true;
        maybeEnableButtons();
    }

    function gisLoaded() {
        codeClient = google.accounts.oauth2.initCodeClient({
            client_id: CLIENT_ID,
            scope: 'openid https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/drive.file',
            ux_mode: 'popup',
            callback: async (response) => {
                if (response.error !== undefined) {
                    console.error(response);
                    return;
                }
                try {
                    const res = await fetch('/store_token', { // Send the authorization code to the server
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ code: response.code }),
                    });
                    const data = await res.json();
                    accessToken = data.access_token;

                    if (accessToken) {
                        document.getElementById('signout_button').style.visibility = 'visible';
                        document.getElementById('select_button').style.visibility = 'visible';
                        document.getElementById('authorize_button').innerText = 'Refresh';
                    }
                } catch (error) {
                    console.error('Error obtaining access token:', error);
                }
            },
        });
        gisInited = true;
        maybeEnableButtons();
    }

    function maybeEnableButtons() {
        if (pickerInited && gisInited) {
            document.getElementById('authorize_button').disabled = false;
        }
    }

    function checkAuthorizationStatus() {


    }

    function handleSignoutClick() {
        if (authorizationCode) {
            google.accounts.oauth2.revoke(accessToken);
            authorizationCode = null;
            document.getElementById('content').innerHTML = '';
            document.getElementById('signout_button').disabled = true;
        }
    }

    async function createPicker() {
        console.log('Creating picker...');
        console.log('accessToken:', accessToken);
        const docsView = new google.picker.DocsView(google.picker.ViewId.DOCS)
            .setMode(google.picker.DocsViewMode.LIST)
            .setMimeTypes('application/vnd.google-apps.document')
            .setParent('root')
            .setEnableDrives(true);

        const foldersView = new google.picker.DocsView(google.picker.ViewId.FOLDERS)
            .setSelectFolderEnabled(true)
            .setMode(google.picker.DocsViewMode.LIST)
            .setParent('root')
            .setEnableDrives(true);

        const picker = new google.picker.PickerBuilder()
            .enableFeature(google.picker.Feature.MULTISELECT_ENABLED)
            .enableFeature(google.picker.Feature.SUPPORT_DRIVES)
            .disableFeature(google.picker.Feature.MINE_ONLY)
            .setDeveloperKey(API_KEY)
            .setAppId(APP_ID)
            .setOAuthToken(accessToken)
            .addView(foldersView)
            .addView(docsView)
            .setCallback(pickerCallback)
            .setOrigin(window.location.protocol + '//' + window.location.host)
            .setTitle('Select documents or folders')
            .build();
        picker.setVisible(true);
    }

    async function pickerCallback(data) {
        if (data.action === google.picker.Action.PICKED) {
            const documents = data[google.picker.Response.DOCUMENTS].map(doc => ({
                id: doc[google.picker.Document.ID],
                name: doc[google.picker.Document.NAME],
                mimeType: doc[google.picker.Document.MIME_TYPE],
                type: doc[google.picker.Document.TYPE],
            }));

            document.getElementById('content').innerHTML += documents.map(doc => `
                <a href="#" class="list-group-item list-group-item-action">
                    <div class="d-flex justify-content-between">
                        <h5 class="mb-1">${doc.name}</h5>
                        <small>${doc.type}</small>
                    </div>
                    <small>${doc.id}</small>
                </a>
            `).join('');

            // Scroll to the Google Drive section
            document.getElementById('google-drive-section').scrollIntoView({ behavior: 'smooth' });

            await fetch('/google/drive/processfilepicker', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(documents),
            }).catch(console.error);
        }
    }

    async function removeDocument(googleDriveId) {
        await fetch('/google/drive/removefile', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ google_drive_id: googleDriveId }),
        }).catch(console.error)
        .then(() => location.reload());
    }

    document.addEventListener('DOMContentLoaded', function () {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })
    });

</script>

<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
{% endblock %}

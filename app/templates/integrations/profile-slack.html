<div id="card-integration-slack" class="card mb-3">
    <h5 class="h5 card-header">Slack Integration</h5>
    <div class="card-body bg-light">
        <div class="row">
            <div class="col-md-4">
                <img src="{{ url_for('static', filename='img/slack.png') }}" alt="Slack Integration" class="img-fluid">
            </div>
            <div class="col-md-8">
                <h5 class="card-title font-weight-bold">Slack Integration</h5>
                <p class="card-text">Enhance your experience by integrating Slack with our platform.</p>

                {% if slack_auth %}
                    {# Show revoke button if we have an auth record, regardless of channel access #}
                    <button type="button" class="btn btn-danger" onclick="revokeSlackAccess()">
                        Revoke Slack Access
                    </button>
                    <a href="{{ url_for('indexing.indexing_runs', datasource_type='slack') }}" class="btn btn-info">View Indexing History</a>

                    {% if slack_channels %}
                        <div class="mt-3">
                            <h6 class="font-weight-bold">Connected Channels</h6>
                            <p class="card-text">Channels you have access to:</p>
                            <ul>
                                {% for channel in slack_channels %}
                                    <li>{{ channel }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% else %}
                        <div class="mt-3">
                            <p class="text-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                Unable to fetch channels. This might be due to permission issues or an invalid token.
                            </p>
                        </div>
                    {% endif %}
                {% else %}
                    <a href="{{ url_for('slack_auth.slack_auth') }}" class="btn">
                        <img alt="Add to Slack" height="40" width="139"
                            src="https://platform.slack-edge.com/img/add_to_slack.png"
                            srcSet="https://platform.slack-edge.com/img/add_to_slack.png 1x, https://platform.slack-edge.com/img/add_to_slack@2x.png 2x"
                        />
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
async function revokeSlackAccess() {
    try {
        const response = await makeAuthenticatedRequest('/api/v1/slack/revoke', 'POST');
        const data = await response.json();

        if (response.ok && data.status === 'success') {
            // Show success message and refresh
            const flashMessage = document.createElement('div');
            flashMessage.className = 'alert alert-success';
            flashMessage.textContent = data.message;
            document.querySelector('.card-body').insertBefore(flashMessage, document.querySelector('.card-body').firstChild);

            // Refresh the page after a short delay
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            // Show error message
            const errorMessage = data.message || data.error || 'Failed to revoke Slack access';
            const flashMessage = document.createElement('div');
            flashMessage.className = 'alert alert-danger';
            flashMessage.textContent = errorMessage;
            document.querySelector('.card-body').insertBefore(flashMessage, document.querySelector('.card-body').firstChild);
        }
    } catch (error) {
        console.error('Error revoking Slack access:', error);
        const flashMessage = document.createElement('div');
        flashMessage.className = 'alert alert-danger';
        flashMessage.textContent = 'Failed to revoke Slack access: Network error';
        document.querySelector('.card-body').insertBefore(flashMessage, document.querySelector('.card-body').firstChild);
    }
}
</script>

{% extends "base.html" %}

{% block head %}
<style>
    .price-option {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
    }
    .price-option:last-child {
        border-bottom: none;
    }
    .price-details {
        flex-grow: 1;
    }
    .price-action {
        flex-shrink: 0;
        margin-left: 10px;
    }
    .current-plan-card {
        border: 2px solid #198754;
        box-shadow: 0 0 10px rgba(25, 135, 84, 0.3);
    }
    .current-plan-badge {
        position: absolute;
        top: -10px;
        right: 10px;
        z-index: 1;
    }
</style>
{% endblock %}

{% block content %}
<div id="profile-container" class="container mt-5">
    {% if user is none %}
        <div class="alert alert-danger" role="alert">
            <h4 class="alert-heading">Unauthorized Access!</h4>
            <p>You are not authorized to access this page. Please <a href="/" class="alert-link">login</a> to access this page.</p>
        </div>
    {% else %}
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h1">Profile Settings</h1>
            <div>
                <a href="/" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-left"></i> Back to Chat
                </a>
            </div>
        </div>

        <!-- User Information Section -->
        <div id="card-welcome" class="card mb-2 mt-2">
            <h5 class="card-header h5">Welcome, {{ user.full_name }}!</h5>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item"><strong>Full Name:</strong> {{ user.full_name }}</li>
                    <li class="list-group-item"><strong>Username:</strong> {{ user.username }}</li>
                    <li class="list-group-item"><strong>Email:</strong> {{ user.email }}</li>
                    <li class="list-group-item"><strong>Organisation:</strong> {{ user.organisation }}</li>
                    <li class="list-group-item"><strong>Role:</strong>
                        {% for role in user.roles %}
                            <span class="badge rounded-pill bg-primary me-1">{{ role.name }}</span>
                        {% endfor %}
                    </li>
                </ul>
            </div>
        </div>

        <!-- Current Subscription Section -->
        <div class="card mb-4">
            <div class="card-body">
                <h2 class="card-title h4">Current Subscription</h2>
                {% if current_plan %}
                <div class="alert alert-info">
                    <p class="mb-1"><strong>Plan:</strong> {{ current_plan.plan.plan_name }}</p>
                    <p class="mb-1"><strong>Start Date:</strong> {{ current_plan.start_date.strftime('%Y-%m-%d') if current_plan.start_date else 'N/A' }}</p>
                    <p class="mb-1"><strong>End Date:</strong> {{ current_plan.end_date.strftime('%Y-%m-%d') if current_plan.end_date else 'N/A' }}</p>
                    <p class="mb-1"><strong>Status:</strong> {% if current_plan.is_active %}<span class="badge bg-success">Active</span>{% else %}<span class="badge bg-danger">Inactive</span>{% endif %}</p>
                    {% if current_plan_price > 0 %}
                    <p class="mb-1"><strong>Current Price:</strong> {{ current_plan_currency }} {{ "%.2f"|format(current_plan_price) }}/{{ current_plan.billing_interval or 'month' }}</p>
                    {% endif %}
                    {% if current_plan.billing_interval %}
                    <p class="mb-0"><strong>Billing Interval:</strong> {{ current_plan.billing_interval|capitalize }}</p>
                    {% endif %}
                </div>
                {% if current_plan.is_active and current_plan_price > 0 and user.stripe_customer_id %}
                <button id="manage-billing-btn" class="btn btn-secondary mt-2">
                    <i class="bi bi-credit-card me-1"></i> Manage Billing
                </button>
                {% endif %}
                {% else %}
                <p class="text-muted">No active subscription</p>
                {% endif %}
            </div>
        </div>

        <!-- Available Plans Section -->
        <div class="card">
            <div class="card-body">
                <h2 class="card-title h4">Available Plans</h2>
                <div class="row">
                    {% for plan in enhanced_plans %}
                    <div class="col-md-4 mb-4">
                        <div class="card h-100 position-relative {% if current_plan and current_plan.is_active and current_plan.plan_id == plan.plan_id %}current-plan-card{% endif %}">
                            {% if current_plan and current_plan.is_active and current_plan.plan_id == plan.plan_id %}
                            <div class="current-plan-badge">
                                <span class="badge bg-success">Current Plan</span>
                            </div>
                            {% endif %}
                            <div class="card-body">
                                <h5 class="card-title">{{ plan.plan_name }}</h5>
                                <p class="card-text">{{ plan.description }}</p>
                                <ul class="list-unstyled">
                                    {% if plan.prices %}
                                        <li><strong>Pricing Options:</strong></li>
                                        {% for price in plan.prices %}
                                            <li class="price-option">
                                                <div class="price-details">
                                                    {% if price.recurring %}
                                                        {{ price.currency|upper }} {{ "%.2f"|format(price.unit_amount) }}/{{ price.recurring.interval }}
                                                        {% if price.recurring.interval_count > 1 %}
                                                            ({{ price.recurring.interval_count }} {{ price.recurring.interval }}s)
                                                        {% endif %}
                                                        {% if price.nickname %}
                                                            - {{ price.nickname }}
                                                        {% endif %}
                                                        {% if current_plan and current_plan.is_active and current_plan.plan_id == plan.plan_id %}
                                                            <span class="badge bg-success ms-2">Current Plan</span>
                                                        {% endif %}
                                                    {% else %}
                                                        {{ price.currency|upper }} {{ "%.2f"|format(price.unit_amount) }} (one-time)
                                                        {% if price.nickname %}
                                                            - {{ price.nickname }}
                                                        {% endif %}
                                                        {% if current_plan and current_plan.is_active and current_plan.plan_id == plan.plan_id %}
                                                            <span class="badge bg-success ms-2">Current Plan</span>
                                                        {% endif %}
                                                    {% endif %}
                                                </div>
                                                <div class="price-action">
                                                    <button
                                                        class="btn btn-sm btn-outline-primary"
                                                        onclick="handlePayment({{ plan.plan_id }}, '{{ price.id }}')"
                                                        {% if current_plan and current_plan.is_active and current_plan.plan_id == plan.plan_id %}
                                                        disabled
                                                        title="This is your current plan"
                                                        {% endif %}
                                                    >
                                                        {% if current_plan and current_plan.is_active and current_plan.plan_id == plan.plan_id %}
                                                        Current
                                                        {% else %}
                                                        Select
                                                        {% endif %}
                                                    </button>
                                                </div>
                                            </li>
                                        {% endfor %}
                                    {% else %}
                                        <li><strong>Price:</strong> {{ plan.currency|default('USD') }} {{ "%.2f"|format(plan.price) }}/month</li>
                                    {% endif %}
                                    {% if plan.message_limit_daily %}
                                    <li><strong>Daily Message Limit:</strong> {{ plan.message_limit_daily }}</li>
                                    {% endif %}
                                </ul>
                                {% if not plan.prices %}
                                <button
                                    class="btn btn-primary w-100"
                                    onclick="handlePayment({{ plan.plan_id }})"
                                    {% if current_plan and current_plan.is_active and current_plan.plan_id == plan.plan_id %}
                                    disabled
                                    title="This is your current plan"
                                    {% elif plan.price == 0 and current_plan and current_plan.is_active %}
                                    disabled
                                    title="You cannot downgrade to Free plan while having an active paid plan"
                                    {% endif %}
                                >
                                    {% if current_plan and current_plan.is_active and current_plan.plan_id == plan.plan_id %}
                                    Current Plan
                                    {% elif plan.price == 0 and current_plan and current_plan.is_active %}
                                    Not Available
                                    {% else %}
                                    Subscribe
                                    {% endif %}
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Profile Update Form -->
        <div id="card-update-profile" class="card mb-2 mt-2">
            <h5 class="card-header h5">Update Profile</h5>
            <div class="card-body">
                <form method="POST">
                    <div class="form-group">
                        <label for="bio">Bio</label>
                        <textarea class="form-control" id="bio" name="bio" rows="3">{{ profile.bio if profile else '' }}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="location">Location</label>
                        <input type="text" class="form-control" id="location" name="location" value="{{ profile.location if profile else '' }}">
                    </div>
                    <div class="form-group">
                        <label for="birth_date">Birth Date</label>
                        <input type="date" class="form-control" id="birth_date" name="birth_date" value="{{ profile.birth_date.strftime('%Y-%m-%d') if profile and profile.birth_date else '' }}">
                    </div>
                    <div class="form-group">
                        <label for="avatar_url">Avatar URL</label>
                        <input type="url" class="form-control" id="avatar_url" name="avatar_url" value="{{ profile.avatar_url if profile else '' }}">
                    </div>
                    <button type="submit" class="btn btn-primary">Update Profile</button>
                </form>
            </div>
        </div>

        <!-- API Keys Section -->
        {% include 'sections/api-keys.html' %}

        <!-- Include Indexer -->
        {% include 'sections/indexer.html' %}

        <!-- Marketplace Integration Section -->
        <div id="card-integrations" class="card mb-2 mt-2">
            <h5 class="h5 card-header">Integrations</h5>
            <div class="card-body">
            {% if config.FEATURE_GOOGLE_DRIVE %}
                {% include 'integrations/profile-google.html' %}
            {% else %}
                <p>Google Drive is not available in this environment.</p>
            {% endif %}

            {% if config.FEATURE_SLACK %}
                {% include 'integrations/profile-slack.html' %}
            {% else %}
                <p>Slack is not available in this environment.</p>
            {% endif %}
        </div>
    {% endif %}
</div>

<!-- Payment Success/Error Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

{% endblock %}

{% block scripts %}
<!-- Load our custom Stripe handling -->
<script src="{{ url_for('static', filename='js/stripe.js') }}"></script>
<!-- Tour script -->
<script src="{{ url_for('static', filename='js/tour-profile.js') }}"></script>
{% endblock %}

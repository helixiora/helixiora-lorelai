{% macro get_initials(name) %}
    {%- set words = name.split() -%}
    {%- if words|length >= 2 -%}
        {{ words[0][0]|upper }}{{ words[1][0]|upper }}
    {%- else -%}
        {{ words[0][0]|upper }}{{ words[0][1]|upper if words[0]|length > 1 else '' }}
    {%- endif -%}
{% endmacro %}

{% macro render_plugin_field(field, form_attrs, plugin_name) %}
<div class="mb-3">
    <label for="{{ field.key }}" class="form-label">
        {{ field.title }}
        {% if field.required %}
            <span class="text-danger">*</span>
        {% endif %}
    </label>

    {% if form_attrs.type == 'checkbox' %}
        <div class="form-check">
            <input
                id="{{ field.key }}"
                name="{{ field.key }}"
                {% for attr, value in form_attrs.items() %}
                    {{ attr }}="{{ value }}"
                {% endfor %}
                {% if field.value %}checked{% endif %}
            >
            <label class="form-check-label" for="{{ field.key }}">
                {{ field.description }}
            </label>
        </div>
    {% elif form_attrs.type == 'textarea' %}
        <textarea
            id="{{ field.key }}"
            name="{{ field.key }}"
            {% for attr, value in form_attrs.items() if attr != 'type' %}
                {{ attr }}="{{ value }}"
            {% endfor %}
            {% if field.required %}required{% endif %}
        >{{ field.value or '' }}</textarea>
        <div class="form-text text-muted">
            {{ field.description }}
        </div>
    {% else %}
        <div class="input-group">
            <input
                id="{{ field.key }}"
                name="{{ field.key }}"
                {% for attr, value in form_attrs.items() %}
                    {{ attr }}="{{ value }}"
                {% endfor %}
                {% if field.required %}required{% endif %}
                {% if not field.sensitive %}value="{{ field.value or '' }}"{% endif %}
            >
            {% if form_attrs.type == 'password' %}
                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('{{ field.key }}')">
                    <i class="bi bi-eye"></i>
                </button>
                <button
                    class="btn btn-outline-secondary show-value-btn"
                    type="button"
                    data-plugin="{{ plugin_name }}"
                    data-field="{{ field.key }}"
                    onclick="showCurrentValue(this)">
                    Show Current Value
                </button>
            {% endif %}
        </div>
        <div class="form-text text-muted">
            {{ field.description }}
        </div>
    {% endif %}
</div>
{% endmacro %}

{% macro render_plugin_config(plugin) %}
<div class="card mb-4">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                {% if plugin.logo %}
                    <img src="{{ plugin.logo }}" alt="{{ plugin.display_name }} logo" class="me-3" style="width: 40px; height: 40px; object-fit: contain;">
                {% else %}
                    <div class="me-3 d-flex align-items-center justify-content-center bg-primary text-white rounded" style="width: 40px; height: 40px; font-weight: 500;">
                        {{ get_initials(plugin.display_name) }}
                    </div>
                {% endif %}
                <h5 class="mb-0">{{ plugin.display_name }}</h5>
            </div>
            <div class="text-muted small">
                {% if plugin.version %}
                    <span class="me-3">Version {{ plugin.version }}</span>
                {% endif %}
                {% if plugin.author %}
                    <span>By {{ plugin.author }}</span>
                {% endif %}
            </div>
        </div>
        {% if plugin.description %}
            <p class="text-muted small mb-0 mt-1">{{ plugin.description }}</p>
        {% endif %}
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('datasources.save_config', plugin_name=plugin.name) }}" class="needs-validation" novalidate>
            {% for field in plugin.config %}
                {% if field.form_attrs %}  {# Only render if we have valid form attributes #}
                    {{ render_plugin_field(field, field.form_attrs, plugin.name) }}
                {% endif %}
            {% endfor %}
            <div class="d-flex justify-content-end">
                <button type="submit" class="btn btn-primary">Save Configuration</button>
            </div>
        </form>
    </div>
</div>

<script>
function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    const button = field.nextElementSibling.querySelector('i');
    if (field.type === 'password') {
        field.type = 'text';
        button.classList.remove('bi-eye');
        button.classList.add('bi-eye-slash');
    } else {
        field.type = 'password';
        button.classList.remove('bi-eye-slash');
        button.classList.add('bi-eye');
    }
}

async function showCurrentValue(button) {
    const plugin = button.dataset.plugin;
    const field = button.dataset.field;
    const input = document.getElementById(field);

    try {
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

        const response = await fetch(`/api/v1/datasources/${plugin}/config/${field}`, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
            },
            credentials: 'same-origin'
        });

        if (!response.ok) {
            throw new Error('Failed to fetch value');
        }

        const data = await response.json();
        input.value = data.value;
        input.type = 'text';  // Show the value

        // Automatically hide after 30 seconds
        setTimeout(() => {
            input.type = 'password';
            input.value = '';  // Clear the shown value
        }, 30000);

    } catch (error) {
        console.error('Error fetching value:', error);
        alert('Failed to fetch current value. Please try again.');
    } finally {
        button.disabled = false;
        button.textContent = 'Show Current Value';
    }
}

// Enable Bootstrap form validation
(function () {
    'use strict'
    const forms = document.querySelectorAll('.needs-validation')
    Array.from(forms).forEach(form => {
        form.addEventListener('submit', event => {
            if (!form.checkValidity()) {
                event.preventDefault()
                event.stopPropagation()
            }
            form.classList.add('was-validated')
        }, false)
    })
})()
</script>
{% endmacro %}
